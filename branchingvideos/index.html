<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MIDI Branching</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --accent-a: #00d1ff;
            --accent-b: #ff2e63;
            --text: #f0f0f0;
            --transition: 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 1s ease-out;
            position: relative;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, var(--flash-color, transparent), transparent 85%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        body.flash-a::after { --flash-color: var(--accent-a); opacity: 0.2; }
        body.flash-b::after { --flash-color: var(--accent-b); opacity: 0.2; }

        .container {
            text-align: center;
            z-index: 10;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 3rem;
            opacity: .9;
            font-weight: 300;
            letter-spacing: 2px;
        }

        button {
            background: transparent;
            border: 2px solid;
            color: inherit;
            font-size: 2rem;
            padding: 1.5rem 3rem;
            margin: 0.5rem;
            cursor: pointer;
            border-radius: 12px;
            transition: transform 0.2s ease, border-color var(--transition), color var(--transition);
            min-width: 180px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: currentColor; opacity: 0; transition: opacity var(--transition); z-index: -1;
        }
        button:hover::before { opacity: .15; }
        button:active { transform: scale(.95); }

        button.pressed {
            animation: buttonFlash 0.3s ease-out;
        }
        @keyframes buttonFlash {
            0%, 100% { background: transparent; }
            50% { background: rgba(255,255,255,0.4); }
        }

        #beginBtn { border-color: var(--text); color: var(--text); }

        .choice-btn {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .choice-btn.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .choice-a { border-color: var(--accent-a); color: var(--accent-a); }
        .choice-b { border-color: var(--accent-b); color: var(--accent-b); }

        .fade-in {
            animation: fadeInOnly 0.6s ease-out forwards;
        }
        @keyframes fadeInOnly {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .color-shift-a { background: linear-gradient(135deg, #001a2e, #00334d); }
        .color-shift-b { background: linear-gradient(135deg, #2e0014, #4d0023); }

        .status { display: none; }

        #noteDisplay {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            font-weight: 500;
            color: var(--text);
            opacity: 0;
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.3s ease;
        }
        #noteDisplay.show {
            opacity: 0.9;
            animation: noteFade 1.2s ease-out forwards;
        }
        @keyframes noteFade {
            0%   { opacity: 0; transform: translateX(-50%) translateY(10px); }
            15%  { opacity: 0.9; transform: translateX(-50%) translateY(0); }
            80%  { opacity: 0.9; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">MIDI Branching</h1>
        <button id="beginBtn">Begin</button>
        <div id="status" class="status"></div>
        <div id="choices" style="margin-top:3rem; display:flex; gap:2rem;">
            <button id="btnA" class="choice-btn choice-a">A</button>
            <button id="btnB" class="choice-btn choice-b">B</button>
        </div>
    </div>

    <div id="noteDisplay"></div>

    <script>
        const CHANNEL   = 14;
        const MAX_NOTE  = 127;
        let output      = null;
        let path        = [];
        let isActive    = false;
        let choicesOk   = false;
        let midiReady   = false;

        const titleEl       = document.getElementById('title');
        const beginBtn      = document.getElementById('beginBtn');
        const btnA          = document.getElementById('btnA');
        const btnB          = document.getElementById('btnB');
        const noteDisplay   = document.getElementById('noteDisplay');

function noteForPath(path) {
    if (path.length === 0) return 0;

    // Base note: first node of the current level
    const level = path.length;
    const firstNodeOfLevel = [0, 1, 3, 6, 10, 15, 21, 28][level]; // From your diagram

    let note = firstNodeOfLevel;

    // For each choice, add the offset for B paths
    for (let i = 0; i < path.length; i++) {
        if (path[i] === 1) { // B choice
            // Number of nodes in the A subtree at this depth
            const remainingLevels = path.length - i - 1;
            const aSubtreeSize = 1 << remainingLevels; // 2^remainingLevels
            note += aSubtreeSize;
        }
    }

    return Math.min(note, 127);
}

        function send(note) {
            if (!output || !midiReady || note > MAX_NOTE) return;
            const on  = 0x90 + (CHANNEL - 1);
            const off = 0x80 + (CHANNEL - 1);
            output.send([on, note, 100]);
            setTimeout(() => output.send([off, note, 0]), 100);
            showNoteNumber(note);
        }

        function showNoteNumber(note) {
            noteDisplay.textContent = note;
            noteDisplay.classList.remove('show');
            void noteDisplay.offsetWidth;
            noteDisplay.classList.add('show');
            setTimeout(() => {
                if (noteDisplay.textContent === String(note)) {
                    noteDisplay.classList.remove('show');
                }
            }, 1300);
        }

        async function enableMIDI() {
            if (midiReady) return;
            try {
                const access = await navigator.requestMIDIAccess({ sysex: false });
                midiReady = true;
                const outs = [...access.outputs.values()];
                output = outs.find(o => o.name.includes('IAC Driver') && o.name.includes('Bus 1')) ||
                         outs.find(o => o.name.includes('IAC')) ||
                         outs[0];
            } catch (e) {
                console.warn('MIDI not available');
            }
        }

        async function start() {
            if (isActive || !midiReady) return;
            isActive = true;
            choicesOk = false;
            path = [];
            send(0);
            beginBtn.style.display = 'none';
            titleEl.textContent = 'Choice 1';  // Now says "Choice 1"
            showChoices();
        }

        function showChoices() {
            btnA.classList.add('active', 'fade-in');
            btnB.classList.add('active', 'fade-in');
            choicesOk = true;
        }

        function flashButton(btn) {
            btn.classList.remove('pressed');
            void btn.offsetWidth;
            btn.classList.add('pressed');
            setTimeout(() => btn.classList.remove('pressed'), 300);
        }

        function choose(branch) {
            if (!choicesOk) return;
            choicesOk = false;

            path.push(branch);
            const note = noteForPath(path);
            send(note);

            const flashCls = branch === 0 ? 'flash-a' : 'flash-b';
            const shiftCls = branch === 0 ? 'color-shift-a' : 'color-shift-b';
            const btn = branch === 0 ? btnA : btnB;

            document.body.classList.remove('flash-a', 'flash-b', 'color-shift-a', 'color-shift-b');
            document.body.classList.add(shiftCls);
            document.body.classList.add(flashCls);
            setTimeout(() => document.body.classList.remove(flashCls), 200);
            flashButton(btn);

            setTimeout(() => {
                if (note >= MAX_NOTE) {
                    finish();
                } else {
                    titleEl.textContent = `Choice ${path.length + 1}`;  // Next: Choice 2, 3, ...
                    choicesOk = true;
                }
            }, 600);
        }

        function finish() {
            titleEl.textContent = 'Complete';
            btnA.classList.remove('active');
            btnB.classList.remove('active');
            setTimeout(reset, 2500);
        }

        function reset() {
            beginBtn.style.display = 'block';
            titleEl.textContent = 'MIDI Branching';
            btnA.classList.remove('active', 'fade-in');
            btnB.classList.remove('active', 'fade-in');
            document.body.classList.remove('flash-a', 'flash-b', 'color-shift-a', 'color-shift-b');
            noteDisplay.classList.remove('show');
            isActive = false;
            choicesOk = false;
            path = [];
        }

        beginBtn.addEventListener('click', async () => {
            await enableMIDI();
            start();
        });

        btnA.addEventListener('click', () => choose(0));
        btnB.addEventListener('click', () => choose(1));

        document.addEventListener('keydown', e => {
            if (!isActive && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                enableMIDI().then(start);
                return;
            }
            if (choicesOk) {
                if (e.key.toLowerCase() === 'a') { e.preventDefault(); choose(0); }
                if (e.key.toLowerCase() === 'b') { e.preventDefault(); choose(1); }
            }
        });

        btnA.classList.remove('active');
        btnB.classList.remove('active');
    </script>
</body>
</html>