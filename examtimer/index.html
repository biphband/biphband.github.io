<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Taking Time Manager</title>
  <style>
body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-family: Arial, sans-serif;
  transition: background 1s, color 1s;
}

body.timer-active {
  overflow: hidden;
}

.container {
  text-align: center;
  position: relative;
  width: 100%;
  max-width: 600px;
  padding: 1rem 0;
  transition: color 1s;
}

.timer-content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.timer-screen {
  width: 100%;
  height: 100vh;
}

.title {
  font-family: 'Zapfino', cursive, sans-serif;
  font-size: 2.5rem;
  font-weight: bold;
  padding-top: 1rem;
  margin-bottom: 0;
  position: relative;
  top: 0;
  left: 0;
  width: 100%;
  text-align: center;
}

.date-text {
  font-size: 1.2rem;
  margin-top: -0.5rem;
  margin-bottom: 1rem;
}

.small-text {
  margin-top: -45vh;
  font-size: 2.5rem;
  margin-bottom: 1rem;
}

.countdown {
  font-size: 10rem;
}

.message {
  font-size: 3rem;
  font-weight: bold;
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
}

.notes {
  position: fixed;
  top: 0;
  border-style: dashed;
  border-width: 2px;
  left: 0;
  font-size: 1.2rem;
  text-align: left;
  max-width: 40%;
  word-wrap: break-word;
  padding: 10px;
  white-space: pre-wrap;
}

.notes:empty {
  border: none;
}

.form-section {
  margin: 1.5rem 0;
  padding: 1rem;
  border: 1px solid #ccc;
  border-radius: 5px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  position: relative;
}

.form-section select,
#title-input {
  width: 100%;
  max-width: 300px;
  padding: 0.5rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin: 0 auto;
}

.color-picker {
  position: absolute;
  top: 5px;
  left: 5px;
  width: 40px;
  height: 40px;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
}

.color-grid {
  display: none;
  position: absolute;
  top: 50px;
  left: 5px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 5px;
  grid-template-columns: repeat(3, 40px);
  grid-template-rows: repeat(2, 40px);
  gap: 5px;
  z-index: 10;
}

.color-option {
  width: 40px;
  height: 40px;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
}

.color-option:hover {
  border-color: #000;
}

.color-option.G { background-color: #ffffff; }
.color-option.B { background-color: #1e90ff; }
.color-option.C { background-color: #32cd32; }
.color-option.R { background-color: #ff4500; }
.color-option.P { background-color: #9932cc; }
.color-option.K { background-color: #333333; }

.delete-section {
  position: absolute;
  top: 5px;
  right: 5px;
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  color: #888;
}

.delete-section:hover {
  color: #f00;
}

.add-section-button,
.preview-share-button {
  font-size: 1.2rem;
  padding: 0.8rem 1.5rem;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s;
  margin: 0.5rem;
}

.add-section-button:hover,
.preview-share-button:hover {
  background-color: #45a049;
}

.blue-gradient {
  background: linear-gradient(135deg, #1e90ff, #0e3c6a);
  color: white;
}

.green-gradient {
  background: linear-gradient(135deg, #32cd32, #195819);
  color: white;
}

.red-gradient {
  background: linear-gradient(135deg, #ff4500, #733119);
  color: white;
}

.purple-gradient {
  background: linear-gradient(135deg, #9932cc, #4b0082);
  color: white;
}

.gray-gradient {
  background: linear-gradient(135deg, #ffffff, #d3d3d3);
  color: black;
}

.charcoal-gradient {
  background: linear-gradient(135deg, #333333, #000000);
  color: white;
}

.logocontainer {
  position: fixed;
  right: 20px;
  bottom: 10px;
  z-index: 10;
}

.logo {
  width: 25vh;
  height: auto;
}
  </style>
</head>
<body class="gray-gradient">
  <div class="container">
    <div id="form-screen">
      <select id="title-input">
        <option value="E">English</option>
        <option value="H">History</option>
        <option value="P">Physics</option>
        <option value="C">Chemistry</option>
        <option value="I">Chinese</option>
        <option value="O">Economics</option>
        <option value="B" selected>Biology</option>
        <option value="M">Math</option>
        <option value="Q">Honors Physics</option>
        <option value="R">Honors Biology</option>
        <option value="S">Honors Chemistry</option>
        <option value="A">Pre-Calculus A</option>
        <option value="U">Pre-Calculus B</option>
        <option value="V">Pre-Calculus AB</option>
        <option value="W">Chinese 9</option>
        <option value="X">Chinese 10</option>
        <option value="Y">Chinese 11</option>
      </select>
      <div id="sections-container">
        <div class="form-section" data-id="1">
          <div class="color-picker" id="color-picker-1" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-1">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <button class="delete-section" onclick="deleteSection(1)">x</button>
          <select id="label-1">
            <option value="A" selected>Attendance</option>
            <option value="D">Distribution of Exam</option>
            <option value="B">BIBSC Section</option>
            <option value="T">Exam Transition</option>
            <option value="C">Common Section</option>
            <option value="M">Multiple Choice</option>
            <option value="F">Free Response</option>
            <option value="E">Essay</option>
            <option value="R">Break</option>
          </select>
          <select id="time-1"></select>
          <select id="notes-1">
            <option value="X"></option>
            <option value="C" selected>Clear your desk except for a pencil and eraser...</option>
            <option value="D">Do not flip over your exam booklet until instructed...</option>
            <option value="N">Confirm that your name is on your exam booklet</option>
            <option value="B">During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P">Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
        <div class="form-section" data-id="2">
          <div class="color-picker" id="color-picker-2" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-2">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <button class="delete-section" onclick="deleteSection(2)">x</button>
          <select id="label-2">
            <option value="A">Attendance</option>
            <option value="D" selected>Distribution of Exam</option>
            <option value="B">BIBSC Section</option>
            <option value="T">Exam Transition</option>
            <option value="C">Common Section</option>
            <option value="M">Multiple Choice</option>
            <option value="F">Free Response</option>
            <option value="E">Essay</option>
            <option value="R">Break</option>
          </select>
          <select id="time-2"></select>
          <select id="notes-2">
            <option value="X"></option>
            <option value="C">Clear your desk except for a pencil and eraser...</option>
            <option value="D" selected>Do not flip over your exam booklet until instructed...</option>
            <option value="N">Confirm that your name is on your exam booklet</option>
            <option value="B">During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P">Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
        <div class="form-section" data-id="3">
          <div class="color-picker" id="color-picker-3" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-3">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <button class="delete-section" onclick="deleteSection(3)">x</button>
          <select id="label-3">
            <option value="A">Attendance</option>
            <option value="D">Distribution of Exam</option>
            <option value="B" selected>BIBSC Section</option>
            <option value="T">Exam Transition</option>
            <option value="C">Common Section</option>
            <option value="M">Multiple Choice</option>
            <option value="F">Free Response</option>
            <option value="E">Essay</option>
            <option value="R">Break</option>
          </select>
          <select id="time-3"></select>
          <select id="notes-3">
            <option value="X"></option>
            <option value="C">Clear your desk except for a pencil and eraser...</option>
            <option value="D">Do not flip over your exam booklet until instructed...</option>
            <option value="N" selected>Confirm that your name is on your exam booklet</option>
            <option value="B">During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P">Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
        <div class="form-section" data-id="4">
          <div class="color-picker" id="color-picker-4" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-4">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <button class="delete-section" onclick="deleteSection(4)">x</button>
          <select id="label-4">
            <option value="A">Attendance</option>
            <option value="D">Distribution of Exam</option>
            <option value="B">BIBSC Section</option>
            <option value="T" selected>Exam Transition</option>
            <option value="C">Common Section</option>
            <option value="M">Multiple Choice</option>
            <option value="F">Free Response</option>
            <option value="E">Essay</option>
            <option value="R">Break</option>
          </select>
          <select id="time-4"></select>
          <select id="notes-4">
            <option value="X"></option>
            <option value="C">Clear your desk except for a pencil and eraser...</option>
            <option value="D">Do not flip over your exam booklet until instructed...</option>
            <option value="N">Confirm that your name is on your exam booklet</option>
            <option value="B" selected>During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P">Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
        <div class="form-section" data-id="5">
          <div class="color-picker" id="color-picker-5" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-5">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <button class="delete-section" onclick="deleteSection(5)">x</button>
          <select id="label-5">
            <option value="A">Attendance</option>
            <option value="D">Distribution of Exam</option>
            <option value="B">BIBSC Section</option>
            <option value="T">Exam Transition</option>
            <option value="C" selected>Common Section</option>
            <option value="M">Multiple Choice</option>
            <option value="F">Free Response</option>
            <option value="E">Essay</option>
            <option value="R">Break</option>
          </select>
          <select id="time-5"></select>
          <select id="notes-5">
            <option value="X"></option>
            <option value="C">Clear your desk except for a pencil and eraser...</option>
            <option value="D">Do not flip over your exam booklet until instructed...</option>
            <option value="N" selected>Confirm that your name is on your exam booklet</option>
            <option value="B">During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P">Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
        <div class="form-section" data-id="6">
          <div class="color-picker" id="color-picker-6" style="background-color: #ffffff;"></div>
          <div class="color-grid" id="color-grid-6">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          <select id="label-6">
            <option value="Z" selected>End of Exam</option>
          </select>
          <select id="time-6"></select>
          <select id="notes-6">
            <option value="X"></option>
            <option value="C">Clear your desk except for a pencil and eraser...</option>
            <option value="D">Do not flip over your exam booklet until instructed...</option>
            <option value="N">Confirm that your name is on your exam booklet</option>
            <option value="B">During the break: Go to the restroom, Stretch your legs...</option>
            <option value="P" selected>Pencils down. Prepare exams for collection.</option>
          </select>
        </div>
      </div>
      <button class="add-section-button" id="add-section">Add Section</button>
      <button class="preview-share-button" id="preview-share-btn">Preview / Share</button>
    </div>
    <div id="timer-screen" class="timer-screen" style="display: none;">
      <div class="title" id="title-display"></div>
      <div class="date-text" id="date-display"></div>
      <div class="timer-content">
        <div class="notes" id="notes-display"></div>
        <div class="small-text" id="status"></div>
        <div class="countdown" id="countdown">00:00</div>
      </div>
      <div class="logocontainer">
        <img src="blacklogo.png" class="logo" id="logo-image">
      </div>
    </div>
  </div>
  <script>
const titleMap = {
  'E': 'English', 'H': 'History', 'P': 'Physics', 'C': 'Chemistry', 'I': 'Chinese',
  'O': 'Economics', 'B': 'Biology', 'M': 'Math', 'Q': 'Honors Physics',
  'R': 'Honors Biology', 'S': 'Honors Chemistry', 'A': 'Pre-Calculus A',
  'U': 'Pre-Calculus B', 'V': 'Pre-Calculus AB', 'W': 'Chinese 9',
  'X': 'Chinese 10', 'Y': 'Chinese 11'
};

const labelMap = {
  'A': 'Attendance', 'D': 'Distribution of Exam', 'B': 'BIBSC Section',
  'T': 'Exam Transition', 'C': 'Common Section', 'M': 'Multiple Choice',
  'F': 'Free Response', 'E': 'Essay', 'R': 'Break', 'Z': 'End of Exam'
};

const notesMap = {
  'X': '',
  'C': 'Clear your desk except for a pencil and eraser\nAny water, pencil cases, etc. can be placed on the floor next to you',
  'D': 'Do not flip over your exam booklet until instructed to do so',
  'N': 'Confirm that your name is on your exam booklet',
  'B': 'During the break:\n✅ Go to the restroom\n✅ Stretch your legs\n✅ Mentally prepare\n\n❌ Check devices, notes\n❌ Discuss test details\n❌ Open backpacks',
  'P': 'Pencils down. Prepare exams for collection.'
};

const colorMap = {
  'B': { light: '#1e90ff', dark: '#0e3c6a', class: 'blue-gradient', text: 'white' },
  'C': { light: '#32cd32', dark: '#195819', class: 'green-gradient', text: 'white' },
  'R': { light: '#ff4500', dark: '#733119', class: 'red-gradient', text: 'white' },
  'P': { light: '#9932cc', dark: '#4b0082', class: 'purple-gradient', text: 'white' },
  'G': { light: '#ffffff', dark: '#d3d3d3', class: 'gray-gradient', text: 'black' },
  'K': { light: '#333333', dark: '#000000', class: 'charcoal-gradient', text: 'white' }
};

const timeMap = new Map();
for (let hour = 0; hour < 24; hour++) {
  for (let minute = 0; minute < 60; minute += 10) {
    const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    const code = String(hour * 6 + minute / 10).padStart(2, '0');
    timeMap.set(code, time);
    timeMap.set(time, code);
  }
}

let sections = [
  { id: 1, label: 'A', time: '08:00', notes: 'C', color: 'G' },
  { id: 2, label: 'D', time: '08:10', notes: 'D', color: 'G' },
  { id: 3, label: 'B', time: '08:20', notes: 'N', color: 'G' },
  { id: 4, label: 'T', time: '09:20', notes: 'B', color: 'G' },
  { id: 5, label: 'C', time: '09:30', notes: 'N', color: 'G' },
  { id: 6, label: 'Z', time: '09:40', notes: 'P', color: 'G' }
];
let nextId = 7;
let schedule = [];
let timer;
let title = 'B';
let hasPlayedSound = {};
let milestoneSounds = {};
let audioContext;

function populateTimeDropdowns() {
  const times = Array.from(timeMap.entries())
    .filter(([key]) => key.length === 2)
    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
  sections.forEach(section => {
    const select = document.getElementById(`time-${section.id}`);
    if (select) {
      select.innerHTML = times.map(([code, time]) =>
        `<option value="${code}" ${time === section.time ? 'selected' : ''}>${time}</option>`
      ).join('');
    }
  });
}

function setupColorPickers() {
  sections.forEach(section => {
    const picker = document.getElementById(`color-picker-${section.id}`);
    const grid = document.getElementById(`color-grid-${section.id}`);
    if (picker && grid) {
      picker.style.backgroundColor = colorMap[section.color].light;
      picker.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.color-grid').forEach(g => {
          if (g !== grid) g.style.display = 'none';
        });
        grid.style.display = grid.style.display === 'grid' ? 'none' : 'grid';
      };
      grid.querySelectorAll('.color-option').forEach(option => {
        option.onclick = (e) => {
          e.stopPropagation();
          section.color = option.dataset.value;
          picker.style.backgroundColor = colorMap[section.color].light;
          grid.style.display = 'none';
        };
      });
    }
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.color-picker') && !e.target.closest('.color-grid')) {
      document.querySelectorAll('.color-grid').forEach(grid => {
        grid.style.display = 'none';
      });
    }
  });
}

function playBeep(frequency = 1000, duration = 0.11) {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  const oscillator = audioContext.createOscillator();
  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  const gainNode = audioContext.createGain();
  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01);
  gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  oscillator.start();
  oscillator.stop(audioContext.currentTime + duration);
}

function playEndSound() {
  playBeep(1000, 0.11);
  setTimeout(() => playBeep(1000, 0.11), 150);
}

function playMilestoneBeep() {
  playBeep(800, 0.1);
}

function formatDate(date) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  const day = date.getDate();
  const suffix = (day % 10 === 1 && day !== 11) ? 'st' : (day % 10 === 2 && day !== 12) ? 'nd' : (day % 10 === 3 && day !== 13) ? 'rd' : 'th';
  return `${months[date.getMonth()]} ${day}${suffix}, ${date.getFullYear()}`;
}

function deleteSection(id) {
  if (sections.length <= 2 || id === 6) {
    alert('At least one section is required before End of Exam.');
    return;
  }
  sections = sections.filter(section => section.id !== id);
  const sectionElement = document.querySelector(`.form-section[data-id="${id}"]`);
  if (sectionElement) sectionElement.remove();
}

function addSection() {
  const endOfExam = sections.find(s => s.id === 6);
  sections = sections.filter(s => s.id !== 6);
  sections.push({ id: nextId, label: 'A', time: '00:00', notes: 'X', color: 'G' });
  sections.push(endOfExam);
  const sectionsContainer = document.getElementById('sections-container');
  const endOfExamElement = sectionsContainer.querySelector(`.form-section[data-id="6"]`);
  sectionsContainer.removeChild(endOfExamElement);
  const newSection = document.createElement('div');
  newSection.className = 'form-section';
  newSection.dataset.id = nextId;
  newSection.innerHTML = `
    <div class="color-picker" id="color-picker-${nextId}" style="background-color: #ffffff;"></div>
    <div class="color-grid" id="color-grid-${nextId}">
      <div class="color-option G" data-value="G"></div>
      <div class="color-option B" data-value="B"></div>
      <div class="color-option C" data-value="C"></div>
      <div class="color-option R" data-value="R"></div>
      <div class="color-option P" data-value="P"></div>
      <div class="color-option K" data-value="K"></div>
    </div>
    <button class="delete-section" onclick="deleteSection(${nextId})">x</button>
    <select id="label-${nextId}">
      <option value="A" selected>Attendance</option>
      <option value="D">Distribution of Exam</option>
      <option value="B">BIBSC Section</option>
      <option value="T">Exam Transition</option>
      <option value="C">Common Section</option>
      <option value="M">Multiple Choice</option>
      <option value="F">Free Response</option>
      <option value="E">Essay</option>
      <option value="R">Break</option>
    </select>
    <select id="time-${nextId}">
      ${Array.from(timeMap.entries())
        .filter(([key]) => key.length === 2)
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
        .map(([code, time]) => `<option value="${code}">${time}</option>`)
        .join('')}
    </select>
    <select id="notes-${nextId}">
      <option value="X" selected></option>
      <option value="C">Clear your desk...</option>
      <option value="D">Do not flip over...</option>
      <option value="N">Confirm that your...</option>
      <option value="B">During the break...</option>
      <option value="P">Pencils down...</option>
    </select>
  `;
  sectionsContainer.appendChild(newSection);
  sectionsContainer.appendChild(endOfExamElement);
  populateTimeDropdowns();
  setupColorPickers();
  nextId++;
}

function generateShareUrl() {
  const titleCode = document.getElementById('title-input').value || 'B';
  const sectionsData = sections.map(section => {
    const label = document.getElementById(`label-${section.id}`)?.value || 'A';
    const timeCode = document.getElementById(`time-${section.id}`)?.value || '00';
    const notes = document.getElementById(`notes-${section.id}`)?.value || 'X';
    const color = section.color || 'G';
    return `${label}${timeCode}${notes}${color}`;
  }).join('');
  const config = `${titleCode}${sectionsData}`;
  return `${window.location.origin}${window.location.pathname}?config=${encodeURIComponent(config)}`;
}

document.getElementById('add-section').addEventListener('click', addSection);

document.getElementById('preview-share-btn').addEventListener('click', () => {
  const currentDate = new Date().toISOString().split('T')[0];
  title = document.getElementById('title-input').value || 'B';
  schedule = [];
  hasPlayedSound = {};
  milestoneSounds = {};
  for (let section of sections) {
    const label = document.getElementById(`label-${section.id}`)?.value || 'A';
    const timeCode = document.getElementById(`time-${section.id}`)?.value;
    const time = timeMap.get(timeCode) || '00:00';
    const notes = document.getElementById(`notes-${section.id}`)?.value || 'X';
    const color = section.color || 'G';
    if (!timeCode || !timeMap.has(timeCode)) {
      alert(`Invalid time for ${labelMap[label]}. Select a valid time.`);
      return;
    }
    schedule.push({ id: section.id, label, time, notes, color });
    hasPlayedSound[section.id] = false;
    milestoneSounds[section.id] = { '15min': false, '10min': false, '5min': false, '1min': false };
  }
  for (let i = 1; i < schedule.length; i++) {
    const prevTime = new Date(`${currentDate}T${schedule[i-1].time}:00`);
    const currTime = new Date(`${currentDate}T${schedule[i].time}:00`);
    if (currTime <= prevTime) {
      alert('Times must be in chronological order.');
      return;
    }
  }
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioContext.resume().then(() => console.log('Audio context resumed'));
  const url = generateShareUrl();
  window.open(url, '_blank');
});

window.addEventListener('load', () => {
  populateTimeDropdowns();
  setupColorPickers();
  const urlParams = new URLSearchParams(window.location.search);
  const configParam = urlParams.get('config');
  if (configParam) {
    try {
      const config = decodeURIComponent(configParam);
      if (config.length < 1) {
        throw new Error('Config string too short');
      }
      const titleCode = config[0];
      if (!titleMap[titleCode]) {
        throw new Error('Invalid title code');
      }
      title = titleCode;
      document.getElementById('title-input').value = titleCode;
      sections = [];
      const sectionsContainer = document.getElementById('sections-container');
      sectionsContainer.innerHTML = '';
      nextId = 1;
      const sectionLength = 5; // 1 label + 2 time code + 1 notes + 1 color
      if ((config.length - 1) % sectionLength !== 0) {
        throw new Error('Invalid config length');
      }
      const sectionsData = [];
      for (let i = 1; i < config.length; i += sectionLength) {
        sectionsData.push(config.slice(i, i + sectionLength));
      }
      sectionsData.forEach((sectionData, index) => {
        if (sectionData.length !== 5) {
          throw new Error(`Invalid section length for section ${index + 1}`);
        }
        const label = sectionData[0];
        const timeCode = sectionData.slice(1, 3);
        const notes = sectionData[3];
        const color = sectionData[4];
        const time = timeMap.get(timeCode);
        if (!labelMap[label]) {
          throw new Error(`Invalid label code for section ${index + 1}`);
        }
        if (!time) {
          throw new Error(`Invalid time code for section ${index + 1}`);
        }
        if (!notesMap[notes]) {
          throw new Error(`Invalid notes code for section ${index + 1}`);
        }
        if (!colorMap[color]) {
          throw new Error(`Invalid color code for section ${index + 1}`);
        }
        const sectionId = index + 1 === sectionsData.length ? 6 : nextId;
        sections.push({ id: sectionId, label, time, notes, color });
        const newSection = document.createElement('div');
        newSection.className = 'form-section';
        newSection.dataset.id = sectionId;
        newSection.innerHTML = `
          <div class="color-picker" id="color-picker-${sectionId}" style="background-color: ${colorMap[color].light};"></div>
          <div class="color-grid" id="color-grid-${sectionId}">
            <div class="color-option G" data-value="G"></div>
            <div class="color-option B" data-value="B"></div>
            <div class="color-option C" data-value="C"></div>
            <div class="color-option R" data-value="R"></div>
            <div class="color-option P" data-value="P"></div>
            <div class="color-option K" data-value="K"></div>
          </div>
          ${sectionId !== 6 ? `<button class="delete-section" onclick="deleteSection(${sectionId})">x</button>` : ''}
          <select id="label-${sectionId}">
            <option value="A" ${label === 'A' ? 'selected' : ''}>Attendance</option>
            <option value="D" ${label === 'D' ? 'selected' : ''}>Distribution of Exam</option>
            <option value="B" ${label === 'B' ? 'selected' : ''}>BIBSC Section</option>
            <option value="T" ${label === 'T' ? 'selected' : ''}>Exam Transition</option>
            <option value="C" ${label === 'C' ? 'selected' : ''}>Common Section</option>
            <option value="M" ${label === 'M' ? 'selected' : ''}>Multiple Choice</option>
            <option value="F" ${label === 'F' ? 'selected' : ''}>Free Response</option>
            <option value="E" ${label === 'E' ? 'selected' : ''}>Essay</option>
            <option value="R" ${label === 'R' ? 'selected' : ''}>Break</option>
            <option value="Z" ${label === 'Z' ? 'selected' : ''}>End of Exam</option>
          </select>
          <select id="time-${sectionId}">
            ${Array.from(timeMap.entries())
              .filter(([key]) => key.length === 2)
              .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
              .map(([code, t]) => `<option value="${code}" ${code === timeCode ? 'selected' : ''}>${t}</option>`)
              .join('')}
          </select>
          <select id="notes-${sectionId}">
            <option value="X" ${notes === 'X' ? 'selected' : ''}></option>
            <option value="C" ${notes === 'C' ? 'selected' : ''}>Clear your desk...</option>
            <option value="D" ${notes === 'D' ? 'selected' : ''}>Do not flip over...</option>
            <option value="N" ${notes === 'N' ? 'selected' : ''}>Confirm that your...</option>
            <option value="B" ${notes === 'B' ? 'selected' : ''}>During the break...</option>
            <option value="P" ${notes === 'P' ? 'selected' : ''}>Pencils down...</option>
          </select>
        `;
        sectionsContainer.appendChild(newSection);
        if (sectionId !== 6) nextId++;
      });
      schedule = sections.map(section => ({ ...section }));
      schedule.forEach(section => {
        hasPlayedSound[section.id] = false;
        milestoneSounds[section.id] = { '15min': false, '10min': false, '5min': false, '1min': false };
      });
      populateTimeDropdowns();
      setupColorPickers();
      document.getElementById('form-screen').style.display = 'none';
      document.getElementById('timer-screen').style.display = 'block';
      document.body.classList.add('timer-active');
      document.getElementById('title-display').textContent = `${titleMap[title]} Exam`;
      document.getElementById('date-display').textContent = formatDate(new Date());
      updateCountdown();
      timer = setInterval(updateCountdown, 1000);
    } catch (e) {
      console.error('Invalid config in URL:', e.message);
      alert('Invalid configuration in URL. Showing default form.');
      populateTimeDropdowns();
      setupColorPickers();
    }
  }
});

function updateCountdown() {
  const now = new Date();
  const container = document.querySelector('.container');
  const statusText = document.getElementById('status');
  const countdownText = document.getElementById('countdown');
  const notesDisplay = document.getElementById('notes-display');
  const logoImage = document.getElementById('logo-image');

  const currentDate = now.toISOString().split('T')[0];

  if (schedule.length === 0) {
    statusText.style.display = 'none';
    countdownText.className = 'message';
    countdownText.textContent = 'No sections configured.';
    notesDisplay.textContent = '';
    logoImage.src = 'blacklogo.png';
    document.body.className = 'gray-gradient timer-active';
    container.style.color = 'black';
    clearInterval(timer);
    return;
  }

  const firstTime = new Date(`${currentDate}T${schedule[0].time}:00`);
  const midnight = new Date(`${currentDate}T00:00:00`);
  const oneMinuteAfterMidnight = new Date(`${currentDate}T00:01:00`);
  if (now >= oneMinuteAfterMidnight && now < firstTime) {
    document.body.className = `${colorMap[schedule[0].color].class} timer-active`;
    container.style.color = colorMap[schedule[0].color].text;
    logoImage.src = colorMap[schedule[0].color].text === 'white' ? 'whitelogo.png' : 'blacklogo.png';
    statusText.innerHTML = `${labelMap[schedule[0].label]} starts in:`;
    notesDisplay.textContent = notesMap[schedule[0].notes];
    const timeLeft = firstTime - now;
    updateTimerDisplay(timeLeft, countdownText);
    return;
  }

  let currentSection = null;
  let nextTime = null;
  let nextSection = null;
  for (let i = 0; i < schedule.length; i++) {
    const startTime = new Date(`${currentDate}T${schedule[i].time}:00`);
    const endTime = (i + 1 < schedule.length)
      ? new Date(`${currentDate}T${schedule[i+1].time}:00`)
      : startTime;
    if (now >= startTime && now < endTime) {
      currentSection = schedule[i];
      nextTime = endTime;
      nextSection = i + 1 < schedule.length ? schedule[i + 1] : null;
      break;
    } else if (now >= endTime && schedule[i].label === 'Z') {
      // Handle End of Exam
      document.body.className = `${colorMap[schedule[i].color].class} timer-active`;
      container.style.color = colorMap[schedule[i].color].text;
      logoImage.src = colorMap[schedule[i].color].text === 'white' ? 'whitelogo.png' : 'blacklogo.png';
      statusText.style.display = 'none';
      countdownText.className = 'message';
      countdownText.textContent = 'Pencils down. Prepare tests for collection.';
      notesDisplay.textContent = notesMap[schedule[i].notes];
      if (!hasPlayedSound[schedule[i].id]) {
        playEndSound();
        hasPlayedSound[schedule[i].id] = true;
      }
      clearInterval(timer);
      return;
    }
  }

  if (currentSection) {
    if (currentSection.label === 'Z') {
      // Immediate end for End of Exam
      document.body.className = `${colorMap[currentSection.color].class} timer-active`;
      container.style.color = colorMap[currentSection.color].text;
      logoImage.src = colorMap[currentSection.color].text === 'white' ? 'whitelogo.png' : 'blacklogo.png';
      statusText.style.display = 'none';
      countdownText.className = 'message';
      countdownText.textContent = 'Pencils down. Prepare tests for collection.';
      notesDisplay.textContent = notesMap[currentSection.notes];
      if (!hasPlayedSound[currentSection.id]) {
        playEndSound();
        hasPlayedSound[currentSection.id] = true;
      }
      clearInterval(timer);
      return;
    }

    const timeLeft = nextTime - now;
    const secondsLeft = Math.floor(timeLeft / 1000);
    
    if (secondsLeft <= 0 && !hasPlayedSound[currentSection.id]) {
      playEndSound();
      hasPlayedSound[currentSection.id] = true;
      if (nextSection) {
        document.body.className = `${colorMap[nextSection.color].class} timer-active`;
        container.style.color = colorMap[nextSection.color].text;
        logoImage.src = colorMap[nextSection.color].text === 'white' ? 'whitelogo.png' : 'blacklogo.png';
        statusText.textContent = labelMap[nextSection.label];
        notesDisplay.textContent = notesMap[nextSection.notes];
        milestoneSounds[nextSection.id] = { '15min': false, '10min': false, '5min': false, '1min': false };
        updateTimerDisplay(timeLeft, countdownText);
      }
      return;
    }

    document.body.className = `${colorMap[currentSection.color].class} timer-active`;
    container.style.color = colorMap[currentSection.color].text;
    logoImage.src = colorMap[currentSection.color].text === 'white' ? 'whitelogo.png' : 'blacklogo.png';
    statusText.textContent = labelMap[currentSection.label];
    notesDisplay.textContent = notesMap[currentSection.notes];

    if (secondsLeft <= 15 * 60 && secondsLeft > 14 * 60 + 59 && !milestoneSounds[currentSection.id]['15min']) {
      playMilestoneBeep();
      milestoneSounds[currentSection.id]['15min'] = true;
    } else if (secondsLeft <= 10 * 60 && secondsLeft > 9 * 60 + 59 && !milestoneSounds[currentSection.id]['10min']) {
      playMilestoneBeep();
      milestoneSounds[currentSection.id]['10min'] = true;
    } else if (secondsLeft <= 5 * 60 && secondsLeft > 4 * 60 + 59 && !milestoneSounds[currentSection.id]['5min']) {
      playMilestoneBeep();
      milestoneSounds[currentSection.id]['5min'] = true;
    } else if (secondsLeft <= 1 * 60 && secondsLeft > 59 && !milestoneSounds[currentSection.id]['1min']) {
      playMilestoneBeep();
      milestoneSounds[currentSection.id]['1min'] = true;
    }

    updateTimerDisplay(timeLeft, countdownText);
  } else {
    document.body.className = 'gray-gradient timer-active';
    container.style.color = 'black';
    logoImage.src = 'blacklogo.png';
    statusText.style.display = 'none';
    countdownText.className = 'message';
    countdownText.textContent = 'Pencils down. Prepare tests for collection.';
    notesDisplay.textContent = '';
    clearInterval(timer);
  }
}

function updateTimerDisplay(timeLeft, element) {
  if (timeLeft <= 0) {
    element.textContent = '00:00';
    return;
  }
  const minutes = Math.floor(timeLeft / 1000 / 60);
  const seconds = Math.floor((timeLeft / 1000) % 60);
  element.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}
  </script>
</body>
</html>