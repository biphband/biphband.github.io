<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Nutcracker Progress</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        html, body { height:100%; overflow:hidden; font-family:'Courier New',Courier,monospace; background:#f9f9fb; }

        body { padding:20px; display:flex; flex-direction:column; }

        .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; padding:0 10px; flex-shrink:0; position:relative; }
        .title { font-family:'American Typewriter','Courier New',monospace; font-size:2.5rem; color:#333; text-align:center; flex:1; font-weight:normal; position:absolute; left:50%; transform:translateX(-50%); top:0; white-space:nowrap; }
        .date-display { font-size:1rem; color:#555; text-align:right; white-space:nowrap; }
        .percentages { font-size:1rem; color:#555; line-height:1.8; white-space:nowrap; }
        .percentages span { display:inline-flex; align-items:center; gap:6px; }
        .legend-block { width:12px; height:12px; border-radius:2px; display:inline-block; }
        .legend-hs { background:#ff6384; }
        .legend-ms { background:#36a2eb; }

        .chart-container { 
            flex:1; 
            overflow:hidden; 
            position:relative; 
            padding:0 20px 140px 0; 
            min-height:0; 
        }
        #progressChart { 
            width:100% !important; 
            height:97% !important; 
            cursor: default !important; 
        }

        #xLabels {
            position: absolute;
            left: -25px; 
            right: 0;
            bottom: -5px;
            height: 170px;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }

        #xLabels > div {
            position: absolute;
            white-space: nowrap;
            cursor: pointer;
            pointer-events: auto;
            transition: color .1s;
            transform: rotate(-40deg);
            transform-origin: top right;
            text-align: right;
        }
        #xLabels > div:hover { color:#007bff; }

        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.5); justify-content:center; align-items:center; }
        .modal-content { 
            background:#fff; 
            padding:30px; 
            border-radius:12px; 
            width:600px; 
            max-width:90%; 
            text-align:center; 
            box-shadow:0 4px 20px rgba(0,0,0,.2); 
            position:relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            flex: 1;
            text-align: center;
            line-height: 1.3;
            font-family: 'Courier New', monospace;
        }

        .lock-icon {
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.2s;
            position: absolute;
            left: 20px;
            top: 20px;
            user-select: none;
        }
        .lock-icon:hover { opacity: 0.8; }
        .lock-icon.unlocked { color: #28a745; }

        .modal-song-title { font-size:1.5rem; font-weight:bold; margin-bottom:4px; }
        .modal-school { font-size:.95rem; color:#333; cursor:pointer; font-weight:normal; user-select:none; }

        .modal-content input { 
            width:100%; 
            padding:10px; 
            font-size:1.4rem; 
            text-align:center; 
            margin-bottom:12px; 
            border:1px solid #ccc; 
            border-radius:6px; 
            background:#fff; 
            font-family:'Courier New',monospace; 
            font-weight:normal; 
            transition:border .2s; 
        }
        .modal-content input:focus { outline:none; border-color:#007bff; }
        .modal-content input:disabled { 
            background:#f5f5f5; 
            color:#aaa; 
            cursor:not-allowed; 
            border-color:#ddd; 
        }

        .stepper { display:flex; justify-content:center; gap:20px; }
        .modal-content button { 
            padding:4px 8px; 
            font-size:.9rem; 
            cursor:pointer; 
            border:1px solid #ccc; 
            border-radius:4px; 
            background:#f0f0f0; 
            color:#333; 
            width:32px; 
            height:32px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            transition:all .2s; 
        }
        .modal-content button:hover { background:#e0e0e0; border-color:#999; }
        .modal-content button:active { background:#d0d0d0; }
        .modal-content button:disabled {
            background:#f9f9f9;
            color:#ccc;
            border-color:#eee;
            cursor:not-allowed;
        }

        .search-modal .modal-content input { 
            margin-bottom:10px; 
            font-size:1.1rem; 
            padding:10px; 
        }
        .search-results { 
            max-height:300px; 
            overflow-y:auto; 
            margin-top:10px; 
            text-align:left; 
            border:1px solid #ddd; 
            border-radius:6px; 
            background:#fff; 
        }
        .search-result-item { 
            padding:10px 12px; 
            cursor:pointer; 
            border-bottom:1px solid #eee; 
            font-size:.95rem; 
        }
        .search-result-item:hover, .search-result-item.highlighted { background:#e6f7ff; }
        .search-result-item:last-child { border-bottom:none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=American+Typewriter:wght@400&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="percentages" id="percentages">
            <span><div class="legend-block legend-hs"></div> HS percent complete: 0%</span><br>
            <span><div class="legend-block legend-ms"></div> MS percent complete: 0%</span>
        </div>
        <h1 class="title">Nutcracker Progress</h1>
        <div class="date-display" id="date-display"></div>
    </div>

    <div class="chart-container">
        <canvas id="progressChart"></canvas>
        <div id="xLabels"></div>
    </div>

    <!-- Value Modal -->
    <div class="modal" id="valueModal">
        <div class="modal-content">
            <div class="lock-icon" id="lockIcon">ðŸ”’</div>
            <div class="modal-header">
                <h3>
                    <div class="modal-song-title"></div>
                    <div class="modal-school"></div>
                </h3>
            </div>
            <input type="number" id="valueInput" min="0" max="100" step="1" disabled />
            <div class="stepper">
                <button id="decrementBtn" disabled>-</button>
                <button id="incrementBtn" disabled>+</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="searchModal">
        <div class="modal-content search-modal">
            <input type="text" id="searchInput" placeholder="Search for a song..." autocomplete="off" />
            <div class="search-results" id="searchResults"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ----- Song list (removed "A Pine Forest in Winter") -----
        const songs = [
            "Overture", "Scene 1", "March", "Mysterious Stranger", "Presentation of Dolls",
            "Dance of the Dolls", "Introduction of Nutcracker", "Drosselmeyer Consoles Clara",
            "Grandfather Waltz", "Clara and the Nutcracker", "The Battle",
            "Waltz of the Snowflakes", "The Enchanted Palace", "Dance of the Sugar Plum Fairy",
            "Arrival of Clara and Prince", "Russian Dance", "Arabian Dance", "Chinese Dance",
            "Dance of the Reed Flutes", "Mother Ginger", "Waltz of the Flowers", "Intrada", "Final Waltz"
        ];

        const STORAGE_KEY = 'nutcracker_progress';
        const data = { ms: Array(songs.length).fill(0), hs: Array(songs.length).fill(0) };

        let currentIndex = -1;
        let currentType = 'ms';
        let chart;
        let isEditingUnlocked = false;

        // ---------- Storage ----------
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                const oldMs = parsed.ms || [];
                const oldHs = parsed.hs || [];
                data.ms = songs.map((_, i) => oldMs[i] ?? 0);
                data.hs = songs.map((_, i) => oldHs[i] ?? 0);
            }
        }
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updatePercentages();
        }
        function updatePercentages() {
            const msAvg = data.ms.reduce((a,b)=>a+b,0)/data.ms.length;
            const hsAvg = data.hs.reduce((a,b)=>a+b,0)/data.hs.length;
            document.querySelector('#percentages span:nth-child(1)').innerHTML = 
                `<div class="legend-block legend-hs"></div> HS percent complete: ${hsAvg.toFixed(1)}%`;
            document.querySelector('#percentages span:nth-child(3)').innerHTML = 
                `<div class="legend-block legend-ms"></div> MS percent complete: ${msAvg.toFixed(1)}%`;
        }

        // ---------- Chart ----------
        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');

            const labelsContainer = document.getElementById('xLabels');
            labelsContainer.innerHTML = '';

            songs.forEach((song, i) => {
                const div = document.createElement('div');
                div.textContent = song;
                div.title = song;
                div.dataset.index = i;
                div.onclick = () => openValueModal(i, 'ms');
                labelsContainer.appendChild(div);
            });

            // ---- Label positioning (fixed) ----
            function updateLabelPositions() {
                if (!chart || !chart.chartArea || !chart.scales?.x) return;

                const { chartArea, scales, ctx } = chart;
                const xScale = scales.x;

                const barWidth = xScale.getPixelForValue(1) - xScale.getPixelForValue(0);
                const categoryPercentage = chart.options.scales.x.categoryPercentage || 0.8;
                const barGroupWidth = barWidth * categoryPercentage;
                const rightEdgeOffset = barGroupWidth / 2;

                ctx.font = 'bold 14px "Courier New", monospace';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                labelsContainer.querySelectorAll('div').forEach((label, i) => {
                    const tickPixel = xScale.getPixelForTick(i);
                    const barCenterX = tickPixel;
                    const barRightEdge = barCenterX + rightEdgeOffset;
                    const text = label.textContent;
                    const textWidth = ctx.measureText(text).width;
                    const leftPos = barRightEdge - textWidth;
                    label.style.left = `${leftPos}px`;
                });
            }

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: songs.map(() => ''),
                    datasets: [
                        { label:'Middle School', data:data.ms, backgroundColor: ctx=>makeGradient(ctx,'#64b4ff','#36a2eb'), borderColor:'#36a2eb', borderWidth:1, barThickness:24, categoryPercentage:0.8, borderRadius:4 },
                        { label:'High School',   data:data.hs, backgroundColor: ctx=>makeGradient(ctx,'#ff8ca0','#ff6384'), borderColor:'#ff6384', borderWidth:1, barThickness:24, categoryPercentage:0.8, borderRadius:4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false, ticks: { display: false }, grid: { display: false } },
                        y: { beginAtZero: true, max: 100, ticks: { stepSize: 20 }, title: { display: true, text: 'Progress (%)' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y}%` } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const { index, datasetIndex } = elements[0];
                            openValueModal(index, datasetIndex === 0 ? 'ms' : 'hs');
                        }
                    },
                    events: ['mousemove', 'mouseout', 'click'],
                    hover: {
                        mode: 'nearest',
                        intersect: true,
                        onHover: (e, elements) => {
                            const canvas = chart.canvas;
                            canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                        }
                    },
                    animation: {
                        onComplete: () => updateLabelPositions()
                    }
                }
            });

            // Resize handling
            const resizeObserver = new ResizeObserver(() => {
                requestAnimationFrame(updateLabelPositions);
            });
            resizeObserver.observe(chart.canvas);

            // Keep labels in sync when chart.update is called
            const originalUpdate = chart.update;
            chart.update = function (...args) {
                const result = originalUpdate.apply(this, args);
                setTimeout(updateLabelPositions, 50);
                return result;
            };

            // Initial positioning (after first render)
            setTimeout(updateLabelPositions, 150);
        }

        function makeGradient(ctx, start, end) {
            const { chartArea } = ctx.chart;
            if (!chartArea) return start;
            const grad = ctx.chart.ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            grad.addColorStop(0, start);
            grad.addColorStop(1, end);
            return grad;
        }

        // ---------- Modal ----------
        function openValueModal(index, type) {
            currentIndex = index;
            currentType = type;
            const song = songs[index];
            const school = type === 'ms' ? 'Middle School' : 'High School';
            document.querySelector('.modal-song-title').textContent = song;
            const schoolEl = document.querySelector('.modal-school');
            schoolEl.textContent = school;
            schoolEl.dataset.type = type;
            document.getElementById('valueInput').value = data[type][index];
            document.getElementById('valueModal').style.display = 'flex';
            document.getElementById('valueInput').focus().select();

            isEditingUnlocked = false;
            updateLockState();
        }

        function closeValueModal() {
            document.getElementById('valueModal').style.display = 'none';
            isEditingUnlocked = false;
            updateLockState();
        }

        function updateLockState() {
            const lockIcon = document.getElementById('lockIcon');
            const input = document.getElementById('valueInput');
            const decBtn = document.getElementById('decrementBtn');
            const incBtn = document.getElementById('incrementBtn');

            if (isEditingUnlocked) {
                lockIcon.textContent = 'âœ…';
                lockIcon.classList.add('âœ…');
                input.disabled = false;
                decBtn.disabled = false;
                incBtn.disabled = false;
            } else {
                lockIcon.textContent = 'ðŸ”’';
                lockIcon.classList.remove('âœ…');
                input.disabled = true;
                decBtn.disabled = true;
                incBtn.disabled = true;
            }
        }

        function unlockEditing() {
            const password = prompt('Enter password to edit:');
            if (password === '6767') {
                isEditingUnlocked = true;
                updateLockState();
                document.getElementById('valueInput').focus().select();
            } else if (password !== null) {
                alert('Incorrect password.');
            }
        }

        function updateValueFromInput() {
            if (!isEditingUnlocked) return;
            let val = Math.max(0, Math.min(100, parseInt(document.getElementById('valueInput').value) || 0));
            document.getElementById('valueInput').value = val;
            data[currentType][currentIndex] = val;
            chart.data.datasets[currentType === 'ms' ? 0 : 1].data[currentIndex] = val;
            saveData();
            chart.update(400);
        }

        // Toggle MS/HS
        document.querySelector('.modal-school').addEventListener('click', () => {
            if (currentIndex === -1) return;
            const newType = currentType === 'ms' ? 'hs' : 'ms';
            openValueModal(currentIndex, newType);
        });

        document.getElementById('lockIcon').addEventListener('click', unlockEditing);

        // ---------- Search ----------
        let searchResults = [], highlightedIndex = -1;

        function openSearchModal() {
            document.getElementById('searchModal').style.display = 'flex';
            const input = document.getElementById('searchInput');
            input.value = '';
            input.focus();
            updateSearchResults('');
        }

        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('searchInput').value = '';
            highlightedIndex = -1;
            searchResults = [];
        }

        function selectSearchResult(item) {
            closeSearchModal();
            const index = parseInt(item.dataset.index);
            const type = item.dataset.type;
            openValueModal(index, type);
        }

        function updateSearchResults(q) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            searchResults = [];
            highlightedIndex = -1;

            if (!q.trim()) return;

            const lower = q.toLowerCase().trim();
            const matches = [];

            songs.forEach((s, i) => {
                const sl = s.toLowerCase();
                const ms = `${sl} ms`, hs = `${sl} hs`;
                if (ms.includes(lower) || sl.includes(lower)) {
                    matches.push({ i, type: 'ms', label: `${s} - Middle School`, pri: ms.includes(lower) ? 0 : 1 });
                }
                if (hs.includes(lower) || sl.includes(lower)) {
                    matches.push({ i, type: 'hs', label: `${s} - High School`, pri: hs.includes(lower) ? 0 : 1 });
                }
            });

            matches.sort((a, b) => a.pri - b.pri || a.label.localeCompare(b.label));

            matches.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.textContent = m.label;
                div.dataset.index = m.i;
                div.dataset.type = m.type;
                div.onclick = () => selectSearchResult(div);
                container.appendChild(div);
                searchResults.push(div);
                if (i === 0) {
                    div.classList.add('highlighted');
                    highlightedIndex = 0;
                }
            });
        }

        function highlightResult(idx) {
            if (!searchResults.length) return;
            if (highlightedIndex >= 0) searchResults[highlightedIndex].classList.remove('highlighted');
            highlightedIndex = (idx + searchResults.length) % searchResults.length;
            searchResults[highlightedIndex].classList.add('highlighted');
            searchResults[highlightedIndex].scrollIntoView({ block: 'nearest' });
        }

        // ---------- Controls ----------
        document.getElementById('incrementBtn').onclick = () => {
            if (!isEditingUnlocked) return;
            const inp = document.getElementById('valueInput');
            inp.value = Math.min(100, (+inp.value || 0) + 1);
            updateValueFromInput();
        };
        document.getElementById('decrementBtn').onclick = () => {
            if (!isEditingUnlocked) return;
            const inp = document.getElementById('valueInput');
            inp.value = Math.max(0, (+inp.value || 0) - 1);
            updateValueFromInput();
        };

        document.getElementById('valueInput').addEventListener('input', updateValueFromInput);
        document.getElementById('valueInput').addEventListener('keydown', e => {
            if (!isEditingUnlocked) return;
            if (e.key === 'Enter') { updateValueFromInput(); closeValueModal(); }
            else if (e.key === 'Escape') closeValueModal();
            else if (e.key === 'ArrowUp') { e.preventDefault(); document.getElementById('incrementBtn').click(); }
            else if (e.key === 'ArrowDown') { e.preventDefault(); document.getElementById('decrementBtn').click(); }
        });

        window.addEventListener('click', e => {
            if (e.target.id === 'valueModal') closeValueModal();
            if (e.target.id === 'searchModal') closeSearchModal();
        });

        document.addEventListener('keydown', e => {
            const vm = document.getElementById('valueModal').style.display === 'flex';
            const sm = document.getElementById('searchModal').style.display === 'flex';

            if (e.key === 'Escape') {
                if (vm) closeValueModal();
                if (sm) closeSearchModal();
                return;
            }

            if (sm) return;   // let search modal handle its own keys

            if (e.key === 'ArrowLeft') { e.preventDefault(); currentIndex = (currentIndex - 1 + songs.length) % songs.length; openValueModal(currentIndex, currentType); }
            if (e.key === 'ArrowRight') { e.preventDefault(); currentIndex = (currentIndex + 1) % songs.length; openValueModal(currentIndex, currentType); }
            if (e.key === ' ') { e.preventDefault(); if (currentIndex === -1) currentIndex = 0; openValueModal(currentIndex, currentType); }
            if (e.key === '/') { e.preventDefault(); openSearchModal(); }
            if ((e.key === 'm' || e.key === 'M')) { currentType = 'ms'; if (currentIndex === -1) currentIndex = 0; vm ? openValueModal(currentIndex, currentType) : null; }
            if ((e.key === 'h' || e.key === 'H')) { currentType = 'hs'; if (currentIndex === -1) currentIndex = 0; vm ? openValueModal(currentIndex, currentType) : null; }
        });

        document.getElementById('searchInput').addEventListener('input', e => updateSearchResults(e.target.value));
        document.getElementById('searchInput').addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeSearchModal(); return; }
            if (e.key === 'ArrowDown') { e.preventDefault(); highlightResult(highlightedIndex + 1); }
            if (e.key === 'ArrowUp') { e.preventDefault(); highlightResult(highlightedIndex - 1); }
            if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex >= 0) selectSearchResult(searchResults[highlightedIndex]);
            }
        });

        // ---------- Date ----------
        function updateDate() {
            const now = new Date();
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('date-display').textContent = now.toLocaleDateString('en-US', opts);
        }

        // ---------- Init ----------
        window.onload = () => {
            loadData();
            updateDate();
            setInterval(updateDate, 60000);
            initChart();
            updatePercentages();
        };
    </script>
</body>
</html>