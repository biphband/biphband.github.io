<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Dashboard</title>
    <link rel="icon" href="https://cdn.glitch.global/bed65df6-4eb8-4247-853c-e198a6399561/icons%2FBGicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="search-button" onclick="toggleSearchBox()">üîç</button>
    <div class="menu-icon" onclick="toggleTeacherMode()">‚ò∞</div>
    <div id="header">
        <div id="objective">
            <h3>Objective:</h3>
            <ul id="objectiveList"></ul>
        </div>
        <div id="title">
            <h1 onclick="cycleClass()">Class Name</h1>
            <h2 id="timeRange">Time Range</h2>
            <div id="countdowns"></div>
        </div>
        <div id="date">
            <p><h3>Date:</h3></p>
            <p><span id="currentDate"></span></p>
            <p><span id="currentDay"></span></p>
        </div>
    </div>
    <div id="graph-container"></div>
    <div id="teacher-mode">
        <span class="close-button" onclick="closeTopMenu()">&times;</span>
        <button class="export-button" onclick="exportScores()">Export Scores</button>
        <button class="reset-button" onclick="resetAllStudents()">Reset All</button>
        <div class="spreadsheet">
            <div class="spreadsheet-header"><strong>Student</strong></div>
            <div class="spreadsheet-header"><strong onclick="cycleAttendance()">Attendance</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('stands')">Stands</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('ipads')">iPads</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('returned')">Returned</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('engagement')">Engagement</strong></div>
            <div class="spreadsheet-header"><strong>Participation</strong></div>
            <div class="spreadsheet-header"><strong>House Points</strong></div>
        </div>
    </div>
    <div id="floating-menu" class="floating-menu"></div>
    <div id="houseshield">
        <div id="points">0</div>
        <div id="student-name"></div>
    </div>
    <div id="overlay">
        <span class="close-button" onclick="closeTopMenu()">&times;</span>
        <h3>Hotkeys</h3>
        <div id="hotkeys"></div>
        <hr>
        <h3>Within Menus:</h3>
        <div id="menuHotkeys"></div>
    </div>

    <script src="studentlist.js"></script>
    <script src="hotkeys.js"></script>
    <script src="stickynote.js"></script>
    <script>
const positiveEffects = [
    'sounds/villager-positive1.mp3',
    'sounds/villager-positive2.mp3',
    'sounds/villager-positive3.mp3',
    'sounds/villager-positive4.mp3'
];
const negativeEffects50Plus = [
    'sounds/villager-negative0.5.mp3',
    'sounds/villager-negative0.9.mp3',
    'sounds/villager-negative1.5.mp3',
    'sounds/villager-negative3.5.mp3'
];
const negativeEffects10to50 = [
    'sounds/villager-negative3.mp3',
    'sounds/villager-negative4.mp3',
    'sounds/villager-negative5.mp3'
];
const negativeEffect0 = 'sounds/villager-negative6.mp3';

function playRandomSound(soundArray) {
    const randomIndex = Math.floor(Math.random() * soundArray.length);
    const audio = new Audio(soundArray[randomIndex]);
    audio.volume = 0.25;
    audio.play();
}

// SINGLE CLASS: Marathon Rehearsal #1
const classes = [
    {
        name: "Marathon Rehearsal #1",
        days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
        timeRange: "7:15pm - 8:30pm",
        startTime: { hours: 19, minutes: 15 },
        endTime:   { hours: 20, minutes: 30 },
        students: masterList.map(s => ({
            name: s.name,
            birthdate: s.birthdate,
            house: s.house,
            attendance: 'Present',
            stands: true,
            intonation: true,
            returned: true,
            engagement: true,
            score: 100,
            housePoints: 0,
            manualAdjustment: 0
        })),
        teacherModeOrder: masterList.map(s => s.name),
        objectivesKey: "nutcrackerObjectives",
        defaultObjectives: [
            'Intrada, Final Waltz',
            'Clara and the Nutcracker',
            'Snowflakes, Drosselmeyer'
        ],
        sampleObjectives: [
            'Warm-up','Act I Run-through','Act II Run-through','Snow Scene',
            'Waltz of the Flowers','Sugar Plum Fairy','Fight Scene',
            'Costume Check','Props Check','Announcements','Housekeeping'
        ],
        criteria: ['stands', 'intonation', 'returned', 'engagement']
    }
];

let currentClassIndex = 0;
let students = classes[0].students;
let teacherModeOrder = classes[0].teacherModeOrder;
let currentCriteria = classes[0].criteria;

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
//  COUNTDOWN LOGIC ‚Äì ONLY ‚Äústarts in‚Äù + auto-export at end
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function updateCountdowns() {
    const countdownContainer = document.getElementById('countdowns');
    countdownContainer.innerHTML = '';

    const now = new Date();
    const currentClass = classes[currentClassIndex];

    const startTime = new Date(now);
    startTime.setHours(currentClass.startTime.hours, currentClass.startTime.minutes, 0, 0);

    const endTime = new Date(now);
    endTime.setHours(currentClass.endTime.hours, currentClass.endTime.minutes, 0, 0);

    const startDiff = (startTime - now) / 1000;  // seconds until start
    const endDiff   = (endTime   - now) / 1000;  // seconds until end

    // Show ‚ÄúRehearsal begins in ‚Ä¶‚Äù (only in the last 30 minutes)
    if (startDiff > 0 && startDiff <= 1800) {
        const minutes = Math.floor(startDiff / 60);
        const seconds = Math.floor(startDiff % 60);
        const div = document.createElement('div');
        div.className = 'start-countdown';
        div.textContent = `Rehearsal begins in ${minutes}m ${seconds}s`;
        countdownContainer.appendChild(div);
    }

    // Auto-export scores the moment rehearsal officially ends
    if (endDiff < 0 && endDiff > -5) {  // tiny buffer in case of clock drift
        exportScores();
    }
}

// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
//  REST OF YOUR ORIGINAL CODE (unchanged except tiny clean-ups)
// ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function getCurrentClass() { return 0; }

function cycleClass() {
    updateClassDisplay();
    updateCountdowns();
}

function updateClassDisplay() {
    const cls = classes[currentClassIndex];
    document.querySelector('#title h1').textContent = cls.name;
    document.querySelector('#timeRange').textContent = cls.timeRange;
    students = cls.students;
    teacherModeOrder = cls.teacherModeOrder;
    currentCriteria = cls.criteria;
    loadObjectives(cls.objectivesKey);
    createBars();
    if (document.getElementById('teacher-mode').style.display === 'block') {
        populateStudents();
    }
    updateHotkeysDisplay();
    updateCountdowns();
    loadStickyNotes();
}

function loadObjectives(key) {
    const cls = classes[0];
    const objectives = JSON.parse(localStorage.getItem(key)) || cls.defaultObjectives;
    updateObjectiveList(objectives);
}

function saveObjectives(key) {
    const objectives = Array.from(document.querySelectorAll('#objectiveList li')).map(li => li.textContent);
    localStorage.setItem(key, JSON.stringify(objectives));
}

function updateObjectiveList(objectives) {
    const objectiveList = document.getElementById('objectiveList');
    objectiveList.innerHTML = objectives.map(obj => `<li class="editable" onclick="editObjective(this)">${obj}</li>`).join('');
}

/* ‚Ä¶ (all your existing functions below stay exactly the same) ‚Ä¶ */

function editObjective(item) {
    const cls = classes[0];
    const currentItem = item.textContent;
    const index = Array.from(item.parentElement.children).indexOf(item);

    const existingDialog = document.querySelector('div[style*="position: fixed"][style*="z-index: 1000"]');
    if (existingDialog) existingDialog.remove();

    const dialog = document.createElement('div');
    dialog.style.position = 'fixed';
    dialog.style.top = '50%';
    dialog.style.left = '50%';
    dialog.style.transform = 'translate(-50%, -50%)';
    dialog.style.backgroundColor = 'white';
    dialog.style.padding = '20px';
    dialog.style.borderRadius = '5px';
    dialog.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
    dialog.style.zIndex = '1000';
    dialog.style.textAlign = 'center';
    dialog.style.lineHeight = '1.3';
    dialog.style.width = '400px';

    const suggestions = cls.sampleObjectives.map(obj => `
        <a href="#" style="font-size:0.85em;text-decoration:none;display:block;margin:2px 0;"
           onclick="document.querySelector('#objectiveList li:nth-child(${index+1})').textContent='${obj}';
                    saveObjectives('${cls.objectivesKey}');
                    this.closest('div').remove();return false;">${obj}</a>
    `).join('');

    dialog.innerHTML = `
        <h3>Edit Objective</h3>
        <input type="text" id="objectiveInput" value="${currentItem}" style="width:80%;padding:5px;">
        <p style="text-align:left;margin-left:33px;margin-top:10px;">${suggestions}</p>
        <button onclick="const i=document.getElementById('objectiveInput');
                 if(i.value.trim()) document.querySelector('#objectiveList li:nth-child(${index+1})').textContent=i.value.trim();
                 saveObjectives('${cls.objectivesKey}');this.closest('div').remove();">Save</button>
        <button onclick="this.closest('div').remove();">Cancel</button>
    `;

    document.body.appendChild(dialog);
    const input = document.getElementById('objectiveInput');
    setTimeout(() => { input.focus(); input.select(); }, 0);
}

/* (All the rest of your code ‚Äì menu handling, bars, hotkeys, export, etc. ‚Äì remains 100% unchanged) */

let menuStack = [];
let currentZIndex = 1000;
const MODES = { GLOBAL: 'global', SEARCH: 'search', HOUSESHIELD: 'houseshield', STICKY_NOTE: 'sticky_note' };
let currentMode = MODES.GLOBAL;
let currentStudentIndex = -1;
let searchBox = null;
let searchResults = null;
let selectedIndex = 0;
let currentPoints = 0;

/* ‚Ä¶ keep everything else exactly as you had it ‚Ä¶ */

/* Keep your exportScores(), resetAllStudents(), createBars(), showFloatingMenu(), etc. exactly the same */

/* Final init */
window.onload = function() {
    preloadHouseImages();
    currentClassIndex = 0;
    updateClassDisplay();
    updateDateTime();
    loadStickyNotes();
    setInterval(updateDateTime, 60000);
    setInterval(updateCountdowns, 1000);   // only remaining timer
};

createBars();
updateDateTime();
setInterval(updateDateTime, 1000);
</script>
</body>
</html>